<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Personalized Food Plan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
    }
    .card {
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      border-radius: 1.5rem;
      transition: all 0.3s ease;
    }
    .loader {
      border-top-color: #3b82f6;
      animation: spinner 1s linear infinite;
    }
    @keyframes spinner {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="p-4 md:p-8">

  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-10">
      <h1 class="text-4xl font-extrabold text-blue-600">Premium Food Plan Generator</h1>
      <p class="text-lg text-gray-600 mt-2">Generate your personalized, 7-day meal plan and shopping list using AI.</p>
    </header>

    <!-- Input Panel -->
    <div id="input-panel" class="bg-white p-6 card mb-10">
      <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-3">Your Health Profile</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div>
          <label for="goal" class="block text-sm font-medium text-gray-700 mb-2">Primary Goal</label>
          <select id="goal" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <option value="Weight Loss">Weight Loss (Calorie Deficit)</option>
            <option value="Muscle Gain">Muscle Gain (High Protein)</option>
            <option value="Maintenance">Healthy Maintenance</option>
            <option value="Energy Boost">Energy & Focus Boost</option>
          </select>
        </div>
        <div>
          <label for="diet" class="block text-sm font-medium text-gray-700 mb-2">Dietary Type</label>
          <select id="diet" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <option value="Mediterranean">Mediterranean</option>
            <option value="Keto">Keto / Low-Carb</option>
            <option value="Vegan">Vegan / Plant-Based</option>
            <option value="Standard/Balanced">Standard & Balanced</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label for="allergies" class="block text-sm font-medium text-gray-700 mb-2">Allergies/Dislikes (Comma-Separated)</label>
          <input type="text" id="allergies" value="dairy, peanuts" placeholder="e.g., dairy, peanuts, fish"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>
      </div>
      <button onclick="generatePlan()" id="generate-btn"
        class="mt-8 w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50">
        Generate 7-Day Plan & Shopping List
      </button>
    </div>

    <!-- Loader -->
    <div id="loader" class="text-center py-10 hidden">
      <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mx-auto mb-4"></div>
      <p class="text-blue-600 font-semibold">Generating your custom plan...</p>
      <p class="text-sm text-gray-500 mt-2">Please wait a few seconds while AI creates your meal plan.</p>
    </div>

    <!-- Results Container -->
    <div id="results-container" class="grid grid-cols-1 lg:grid-cols-3 gap-8 hidden">
      <!-- Shopping List -->
      <div class="lg:col-span-1 bg-white p-6 card h-fit sticky top-4">
        <h2 class="text-2xl font-semibold text-green-700 mb-4 border-b pb-3 flex justify-between items-center">
          üõí Consolidated Shopping List
          <button id="copy-btn" class="text-sm bg-gray-100 hover:bg-gray-200 text-gray-600 py-1 px-3 rounded-full transition" onclick="copyShoppingList()">Copy List</button>
        </h2>
        <ul id="shopping-list-output" class="space-y-2 text-gray-700 list-disc pl-5"></ul>
      </div>

      <!-- Meal Plan Table -->
      <div class="lg:col-span-2 bg-white p-6 card overflow-x-auto">
        <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-3">üóìÔ∏è 7-Day Meal Schedule</h2>
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-blue-50">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-1/12">Day</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-3/12">Breakfast</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-4/12">Lunch</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-blue-700 uppercase tracking-wider w-4/12">Dinner</th>
            </tr>
          </thead>
          <tbody id="weekly-plan-output" class="bg-white divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    const apiKey = "AIzaSyC_SU6tE8Ret2FTBbiIUjkBS5eItQ0NeP8"; // üîë Replace this with a valid API key

    const generatePlan = async () => {
      const goal = document.getElementById('goal')?.value;
      const diet = document.getElementById('diet')?.value;
      const allergies = document.getElementById('allergies')?.value.trim();

      if (!goal || !diet) {
        alert("Please select both Goal and Diet Type.");
        return;
      }

      showLoader();

      const systemPrompt = `You are a certified nutrition coach and chef. Design a 7-day meal plan matching the user's goals and diet. Each day must have breakfast, lunch, and dinner with a short description. Also include a combined shopping list for all 7 days.`;

      const userQuery = `
        Goal: ${goal}
        Dietary Type: ${diet}
        Allergies/Avoid: ${allergies || 'None'}
        Please respond ONLY with valid JSON using this format:
        {
          "weeklyPlan": [
            {"dayNumber": 1, "breakfast": "", "lunch": "", "dinner": ""},
            ...
          ],
          "shoppingList": ["item1", "item2", ...]
        }`;

      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

      const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: { parts: [{ text: systemPrompt }] },
        generationConfig: { responseMimeType: "application/json" }
      };

      try {
        let attempts = 0;
        let maxAttempts = 3;
        let result = null;

        while (attempts < maxAttempts && !result) {
          attempts++;
          try {
            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const data = await response.json();
            const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("No text returned from API.");
            result = JSON.parse(text);
          } catch (err) {
            console.warn(`Attempt ${attempts} failed:`, err.message);
            if (attempts === maxAttempts) throw err;
          }
        }

        // Render results safely
        if (result?.weeklyPlan && document.getElementById('weekly-plan-output')) renderPlan(result.weeklyPlan);
        if (result?.shoppingList && document.getElementById('shopping-list-output')) renderShoppingList(result.shoppingList);
        hideLoader();
        const resultsContainer = document.getElementById('results-container');
        if (resultsContainer) resultsContainer.classList.remove('hidden');

      } catch (error) {
        console.error(error);
        hideLoader();
        renderError("Failed to generate the plan after 3 tries. Please check your API key or try again later.");
      }
    };

    const renderPlan = (weeklyPlan) => {
      const tbody = document.getElementById('weekly-plan-output');
      if (!tbody) return;
      tbody.innerHTML = '';
      weeklyPlan.forEach(day => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-blue-50 transition duration-150';
        row.innerHTML = `
          <td class="px-3 py-3 text-sm font-bold text-blue-700 border-r">Day ${day.dayNumber}</td>
          <td class="px-3 py-3 text-sm text-gray-600">${day.breakfast}</td>
          <td class="px-3 py-3 text-sm text-gray-600">${day.lunch}</td>
          <td class="px-3 py-3 text-sm text-gray-600">${day.dinner}</td>`;
        tbody.appendChild(row);
      });
    };

    const renderShoppingList = (shoppingList) => {
      const ul = document.getElementById('shopping-list-output');
      if (!ul) return;
      ul.innerHTML = '';
      shoppingList.forEach(item => {
        const li = document.createElement('li');
        li.className = 'text-gray-700 text-sm py-1 border-b last:border-b-0';
        li.textContent = item;
        ul.appendChild(li);
      });
    };

    const showLoader = () => {
      const loader = document.getElementById('loader');
      const btn = document.getElementById('generate-btn');
      if (loader) loader.classList.remove('hidden');
      if (btn) btn.disabled = true;
      const results = document.getElementById('results-container');
      if (results) results.classList.add('hidden');
    };

    const hideLoader = () => {
      const loader = document.getElementById('loader');
      const btn = document.getElementById('generate-btn');
      if (loader) loader.classList.add('hidden');
      if (btn) btn.disabled = false;
    };

    const renderError = (msg) => {
      const results = document.getElementById('results-container');
      if (!results) {
        alert(msg);
        return;
      }
      results.innerHTML = `
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 card" role="alert">
          <p class="font-bold">Error</p><p>${msg}</p>
        </div>`;
      results.classList.remove('hidden');
    };

    const copyShoppingList = () => {
      const list = Array.from(document.querySelectorAll('#shopping-list-output li')).map(li => li.textContent).join('\n');
      navigator.clipboard.writeText(list).then(() => {
        const btn = document.getElementById('copy-btn');
        if (btn) {
          btn.textContent = 'Copied!';
          setTimeout(() => btn.textContent = 'Copy List', 2000);
        }
      });
    };

    window.generatePlan = generatePlan;
    window.copyShoppingList = copyShoppingList;
  </script>
</body>
</html>
